#!/usr/bin/env bash

# Check if daemon is running, if not start it from the .app bundle
# to ensure proper icon handling on macOS
if ! emacsclient -e '(server-running-p)' &>/dev/null; then
  # Find the Emacs.app from home-manager
  emacs_app="$HOME/Applications/Home Manager Apps/Emacs.app"
  if [ -d "$emacs_app" ]; then
    open -a "$emacs_app" --args --daemon
  else
    # Fallback to regular emacs daemon
    emacs --daemon
  fi

  # Wait for daemon to start (poll up to 30 seconds)
  timeout=30
  while [ $timeout -gt 0 ]; do
    if emacsclient -e '(server-running-p)' &>/dev/null; then
      break
    fi
    sleep 0.5
    timeout=$((timeout - 1))
  done
fi

emacsclient "$@"
